<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Home - Messenger Loooviquue</title>
<style>
body { margin:0; font-family: Arial; background:#f0f2f5; display:flex; height:100vh; }
#sidebar { width:300px; background:white; padding:10px; border-right:1px solid #ddd; overflow-y:auto; }
#sidebar h2 { margin:10px 0; color:#1877f2; font-size:16px; }
.user-item, .friend-item, .group-item { display:flex; justify-content:flex-start; align-items:center; padding:8px; margin:5px 0; border-radius:8px; cursor:pointer; transition:0.2s; }
.user-item:hover, .friend-item:hover, .group-item:hover { background:#f0f2f5; }
.user-item img, .friend-item img, .group-item img { width:35px; height:35px; border-radius:50%; margin-right:10px; }
.status { width:10px; height:10px; border-radius:50%; margin-left:-10px; margin-top:25px; border:2px solid white; background:#4caf50; }
button { padding:5px 10px; border:none; border-radius:5px; cursor:pointer; }
#mainContent { flex:1; display:flex; flex-direction:column; }
header { background:#1877f2; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; font-size:16px; }
#chatArea { flex:1; padding:10px; overflow-y:auto; background:#e5ddd5; display:flex; flex-direction:column; }
.message { padding:10px; margin:5px; border-radius:20px; max-width:70%; word-wrap:break-word; display:flex; align-items:flex-end; }
.message.mine { background:#1877f2; color:white; margin-left:auto; justify-content:flex-end;}
.message.other { background:#f0f0f0; color:black; margin-right:auto; justify-content:flex-start;}
.message img { width:30px; height:30px; border-radius:50%; margin-right:5px; }
#inputContainer { display:flex; padding:10px; background:white; border-top:1px solid #ccc; }
#msgInput { flex:1; padding:10px; border-radius:20px; border:1px solid #ccc; }
#sendBtn { padding:10px 20px; margin-left:5px; background:#1877f2; color:white; border:none; border-radius:20px; cursor:pointer; }
@media (max-width:768px){body{flex-direction:column;}#sidebar{width:100%;height:200px;border-right:none;border-bottom:1px solid #ddd;}}
</style>
</head>
<body>

<!-- Sidebar gauche -->
<div id="sidebar">
<h2>Amis / Utilisateurs</h2>
<div id="allUsersContainer"></div>
<h2>Groupes</h2>
<div id="groupsContainer"></div>
<input type="text" id="newGroupName" placeholder="Nom du groupe" style="width:100%; margin:5px 0;">
<button id="createGroupBtn" style="width:100%; background:#1877f2; color:white;">Créer un groupe</button>
</div>

<!-- Section principale -->
<div id="mainContent">
<header>
<span id="chatTitle">Sélectionnez un chat</span>
<button id="logoutBtn">Se déconnecter</button>
</header>

<div id="chatArea"><p>Choisissez un utilisateur ou un groupe pour discuter.</p></div>

<div id="inputContainer">
<input type="text" id="msgInput" placeholder="Écrire un message...">
<button id="sendBtn">Envoyer</button>
</div>
</div>

<script type="module">
import { auth, db, sendFriendRequest, acceptFriendRequest, rejectFriendRequest, createGroup, sendMessage } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const allUsersContainer=document.getElementById("allUsersContainer");
const groupsContainer=document.getElementById("groupsContainer");
const newGroupName=document.getElementById("newGroupName");
const createGroupBtn=document.getElementById("createGroupBtn");
const chatArea=document.getElementById("chatArea");
const chatTitle=document.getElementById("chatTitle");
const msgInput=document.getElementById("msgInput");
const sendBtn=document.getElementById("sendBtn");
const logoutBtn=document.getElementById("logoutBtn");

let currentChatId=null;
let currentChatType=null;

function randomAvatar(id){
  // simple placeholder avatar
  return `https://i.pravatar.cc/150?u=${id}`;
}

onAuthStateChanged(auth,user=>{
if(!user){window.location.replace("login.html");return;}
const uid=user.uid;

logoutBtn.addEventListener("click",()=>{auth.signOut().then(()=>window.location.replace("login.html"));});

// ================= USERS =================
onValue(ref(db,"users"),snapshot=>{
const users=snapshot.val()||{};
allUsersContainer.innerHTML="";
Object.keys(users).forEach(userId=>{
if(userId===uid)return;
const u=users[userId];
const isFriend=users[uid]?.friends?.[userId];
const pendingSent=users[uid]?.pendingRequestsSent?.[userId];
const div=document.createElement("div");
div.className="user-item";
div.innerHTML=`<img src="${randomAvatar(userId)}"><span>${u.username}</span>`;
const status=document.createElement("div");
status.className="status";
div.appendChild(status);
const btn=document.createElement("button");
if(isFriend)btn.textContent="Amis";
else if(pendingSent)btn.textContent="En attente";
else btn.textContent="Ajouter";
btn.disabled=isFriend||pendingSent;
btn.addEventListener("click",()=>sendFriendRequest(userId));
div.appendChild(btn);
div.addEventListener("click",()=>{currentChatId=[uid,userId].sort().join("_"); currentChatType="private"; chatTitle.textContent=u.username; chatArea.innerHTML=""; loadMessages(currentChatId,currentChatType,uid,userId);});
allUsersContainer.appendChild(div);
});
});

// ================= GROUPS =================
onValue(ref(db,"groups"),snapshot=>{
const groups=snapshot.val()||{};
groupsContainer.innerHTML="";
Object.keys(groups).forEach(groupId=>{
const g=groups[groupId];
if(!g.members[uid])return;
const div=document.createElement("div");
div.className="group-item";
div.innerHTML=`<img src="${randomAvatar(groupId)}"><span>${g.name}</span>`;
div.addEventListener("click",()=>{currentChatId=groupId; currentChatType="group"; chatTitle.textContent=g.name; chatArea.innerHTML=""; loadMessages(currentChatId,currentChatType,uid);});
groupsContainer.appendChild(div);
});
});

createGroupBtn.addEventListener("click",()=>{
const name=newGroupName.value.trim();
if(!name)return alert("Entrez un nom de groupe !");
createGroup(name);
newGroupName.value="";
});

// ================= CHAT =================
function loadMessages(chatId,type,uid,otherUser=null){
const chatRef=type==="private"?ref(db,`privateChats/${chatId}`):ref(db,`groups/${chatId}/messages`);
onValue(chatRef,snap=>{
chatArea.innerHTML="";
const msgs=snap.val()||{};
Object.values(msgs).forEach(msg=>{
const div=document.createElement("div");
div.className="message "+(msg.sender===uid?"mine":"other");
div.innerHTML=`${msg.sender===uid?"":`<img src="${randomAvatar(msg.sender)}">`}<span>${msg.senderName||"Autre"}: ${msg.text}</span>`;
chatArea.appendChild(div);
});
chatArea.scrollTop=chatArea.scrollHeight;
});
}

sendBtn.addEventListener("click",()=>{
if(!currentChatId)return alert("Sélectionnez un chat !");
const text=msgInput.value.trim();
if(!text)return;
sendMessage(currentChatId,currentChatType,text);
msgInput.value="";
});

msgInput.addEventListener("keypress",e=>{if(e.key==="Enter")sendBtn.click();});

});
</script>
</body>
</html>
