<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Home - Messenger Loooviquue</title>
<style>
body { margin:0; font-family: Arial; background:#f0f2f5; display:flex; height:100vh; }
#sidebar { width:300px; background:white; padding:10px; border-right:1px solid #ddd; overflow-y:auto; }
#sidebar h2 { margin:10px 0; color:#1877f2; font-size:16px; cursor:pointer; }
.user-item, .friend-item, .pending-item, .group-item { display:flex; justify-content:flex-start; align-items:center; padding:8px; margin:5px 0; border-radius:8px; cursor:pointer; transition:0.2s; }
.user-item:hover, .friend-item:hover, .pending-item:hover, .group-item:hover { background:#f0f0f0; }
.user-item img, .friend-item img, .pending-item img, .group-item img { width:35px; height:35px; border-radius:50%; margin-right:10px; }
button { padding:5px 10px; border:none; border-radius:5px; cursor:pointer; }
#mainContent { flex:1; display:flex; flex-direction:column; }
header { background:#1877f2; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; font-size:16px; }
#chatArea { flex:1; padding:10px; overflow-y:auto; display:flex; flex-direction:column; background:#e5ddd5; }
.message { padding:10px; margin:5px; border-radius:20px; max-width:70%; display:flex; align-items:flex-end; word-wrap:break-word; }
.message.mine { background:#1877f2; color:white; margin-left:auto; justify-content:flex-end;}
.message.other { background:#f0f0f0; color:black; margin-right:auto; justify-content:flex-start;}
.message img { width:30px; height:30px; border-radius:50%; margin-right:5px; }
#inputContainer { display:flex; padding:10px; background:white; border-top:1px solid #ccc; }
#msgInput { flex:1; padding:10px; border-radius:20px; border:1px solid #ccc; }
#sendBtn { padding:10px 20px; margin-left:5px; background:#1877f2; color:white; border:none; border-radius:20px; cursor:pointer; }
@media(max-width:768px){body{flex-direction:column;}#sidebar{width:100%;height:200px;border-right:none;border-bottom:1px solid #ddd;}}
</style>
</head>
<body>

<div id="sidebar">
<h2 id="allUsersTitle">All Users</h2>
<div id="allUsersContainer" style="display:none;"></div>

<h2 id="friendsTitle">Friends</h2>
<div id="friendsContainer" style="display:none;"></div>

<h2 id="pendingTitle">Pending Requests</h2>
<div id="pendingContainer" style="display:none;"></div>

<h2 id="groupsTitle">Groups</h2>
<div id="groupsContainer" style="display:none;"></div>
<input type="text" id="newGroupName" placeholder="Nom du groupe" style="width:100%; margin:5px 0;">
<button id="createGroupBtn" style="width:100%; background:#1877f2; color:white;">Créer un groupe</button>
</div>

<div id="mainContent">
<header>
<span id="chatTitle">Sélectionnez un chat</span>
<button id="logoutBtn">Se déconnecter</button>
</header>

<div id="chatArea"><p>Choisissez un utilisateur ou un groupe pour discuter.</p></div>

<div id="inputContainer">
<input type="text" id="msgInput" placeholder="Écrire un message...">
<button id="sendBtn">Envoyer</button>
</div>
</div>

<script type="module">
import { auth, db, sendFriendRequest, acceptFriendRequest, rejectFriendRequest, createGroup, sendMessage } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { ref, onValue, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const allUsersContainer=document.getElementById("allUsersContainer");
const friendsContainer=document.getElementById("friendsContainer");
const pendingContainer=document.getElementById("pendingContainer");
const groupsContainer=document.getElementById("groupsContainer");
const newGroupName=document.getElementById("newGroupName");
const createGroupBtn=document.getElementById("createGroupBtn");
const chatArea=document.getElementById("chatArea");
const chatTitle=document.getElementById("chatTitle");
const msgInput=document.getElementById("msgInput");
const sendBtn=document.getElementById("sendBtn");
const logoutBtn=document.getElementById("logoutBtn");

const allUsersTitle = document.getElementById("allUsersTitle");
const friendsTitle = document.getElementById("friendsTitle");
const pendingTitle = document.getElementById("pendingTitle");
const groupsTitle = document.getElementById("groupsTitle");

let currentChatId=null;
let currentChatType=null;
let currentUid=null;

function randomAvatar(id){ return `https://i.pravatar.cc/150?u=${id}`; }

// Toggle display sections
allUsersTitle.addEventListener("click",()=>{allUsersContainer.style.display = allUsersContainer.style.display==="none"?"block":"none"; loadAllUsers();});
friendsTitle.addEventListener("click",()=>{friendsContainer.style.display = friendsContainer.style.display==="none"?"block":"none"; loadFriends();});
pendingTitle.addEventListener("click",()=>{pendingContainer.style.display = pendingContainer.style.display==="none"?"block":"none"; loadPending();});
groupsTitle.addEventListener("click",()=>{groupsContainer.style.display = groupsContainer.style.display==="none"?"block":"none"; loadGroups();});

onAuthStateChanged(auth,user=>{
if(!user){window.location.replace("login.html");return;}
currentUid=user.uid;

logoutBtn.addEventListener("click",()=>{auth.signOut().then(()=>window.location.replace("login.html"));});

// ================= LOAD FUNCTIONS =================
function loadAllUsers(){
onValue(ref(db,"users"),snapshot=>{
const users=snapshot.val()||{};
allUsersContainer.innerHTML="";
Object.keys(users).forEach(userId=>{
if(userId===currentUid)return;
const u=users[userId];
const friends=users[currentUid]?.friends||{};
const pendingSent=users[currentUid]?.pendingRequestsSent||{};
const pendingReceived=users[currentUid]?.pendingRequests||{};

if(!friends[userId] && !pendingSent[userId] && !pendingReceived[userId]){
const div=document.createElement("div");
div.className="user-item";
div.innerHTML=`<img src="${randomAvatar(userId)}"><span>${u.username}</span>`;
const btn=document.createElement("button");
btn.textContent="Ajouter";
btn.addEventListener("click",()=>sendFriendRequest(userId));
div.appendChild(btn);
div.addEventListener("click",()=>{openChat(userId,"private",u.username)});
allUsersContainer.appendChild(div);
}
});
});
}

function loadFriends(){
onValue(ref(db,"users"),snapshot=>{
const users=snapshot.val()||{};
friendsContainer.innerHTML="";
Object.keys(users).forEach(userId=>{
if(userId===currentUid)return;
const u=users[userId];
const friends=users[currentUid]?.friends||{};
if(friends[userId]){
const div=document.createElement("div");
div.className="friend-item";
div.innerHTML=`<img src="${randomAvatar(userId)}"><span>${u.username}</span>`;
div.addEventListener("click",()=>{openChat(userId,"private",u.username)});
friendsContainer.appendChild(div);
}
});
});
}

function loadPending(){
onValue(ref(db,"users"),snapshot=>{
const users=snapshot.val()||{};
pendingContainer.innerHTML="";
Object.keys(users).forEach(userId=>{
if(userId===currentUid)return;
const u=users[userId];
const pendingReceived=users[currentUid]?.pendingRequests||{};
if(pendingReceived[userId]){
const div=document.createElement("div");
div.className="pending-item";
div.innerHTML=`<img src="${randomAvatar(userId)}"><span>${u.username}</span>`;
const acceptBtn=document.createElement("button");
acceptBtn.textContent="Accepter";
acceptBtn.addEventListener("click",()=>acceptFriendRequest(userId));
const rejectBtn=document.createElement("button");
rejectBtn.textContent="Refuser";
rejectBtn.addEventListener("click",()=>rejectFriendRequest(userId));
div.appendChild(acceptBtn);
div.appendChild(rejectBtn);
pendingContainer.appendChild(div);
}
});
});
}

function loadGroups(){
onValue(ref(db,"groups"),snapshot=>{
const groups=snapshot.val()||{};
groupsContainer.innerHTML="";
Object.keys(groups).forEach(groupId=>{
const g=groups[groupId];
if(!g.members[currentUid])return;
const div=document.createElement("div");
div.className="group-item";
div.innerHTML=`<img src="${randomAvatar(groupId)}"><span>${g.name}</span>`;
div.addEventListener("click",()=>{openChat(groupId,"group",g.name)});
groupsContainer.appendChild(div);
});
});
}

// ================= CREATE GROUP =================
createGroupBtn.addEventListener("click",()=>{
const name=newGroupName.value.trim();
if(!name)return alert("Entrez un nom de groupe !");
createGroup(name);
newGroupName.value="";
});

// ================= CHAT =================
function openChat(id,type,name){
currentChatId=id;
currentChatType=type;
chatTitle.textContent=name;
chatArea.innerHTML="";

const chatRef=type==="private"?ref(db,`privateChats/${[currentUid,id].sort().join("_")}`):ref(db,`groups/${id}/messages`);
onValue(chatRef,snap=>{
chatArea.innerHTML="";
const msgs=snap.val()||{};
Object.values(msgs).forEach(msg=>{
const div=document.createElement("div");
div.className="message "+(msg.sender===currentUid?"mine":"other");
div.innerHTML=`${msg.sender===currentUid?"":`<img src="${randomAvatar(msg.sender)}">`}<span>${msg.senderName||"Autre"}: ${msg.text}</span>`;
chatArea.appendChild(div);
});
chatArea.scrollTop=chatArea.scrollHeight;
});
}

// ================= SEND MESSAGE =================
sendBtn.addEventListener("click",()=>sendCurrentMessage());
msgInput.addEventListener("keypress",e=>{if(e.key==="Enter")sendCurrentMessage();});

function sendCurrentMessage(){
if(!currentChatId)return alert("Sélectionnez un chat !");
const text=msgInput.value.trim();
if(!text)return;
sendMessage(currentChatId,currentChatType,text);
msgInput.value="";
}

});
</script>
</body>
</html>
