<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Home</title>
<style>
  body { font-family: Arial; margin:0; padding:0; display:flex; flex-direction:column; background:#f9f9f9; }
  header { background:#4a90e2; color:white; padding:15px; text-align:center; }
  main { display:flex; flex-direction:row; flex-wrap:wrap; padding:10px; }
  section { flex:1 1 300px; border:1px solid #ccc; margin:5px; padding:10px; border-radius:5px; background:white; }
  h2 { margin-top:0; }
  input, button { padding:5px; margin:5px 0; }
  .user-item, .friend-item, .chat-item, .group-item { border:1px solid #ddd; padding:5px; margin:3px 0; border-radius:3px; display:flex; justify-content:space-between; align-items:center; }
</style>
</head>
<body>
<header>
  <h1>Accueil</h1>
  <button id="logoutBtn" style="background:#e74c3c;color:white;border:none;padding:10px;border-radius:5px;cursor:pointer;">Se déconnecter</button>
</header>

<main>
  <!-- ALL USERS -->
  <section>
    <h2>Tous les utilisateurs</h2>
    <div id="allUsersContainer"></div>
  </section>

  <!-- FRIENDS -->
  <section>
    <h2>Amis</h2>
    <div id="friendsContainer"></div>
  </section>

  <!-- PENDING -->
  <section>
    <h2>Demandes reçues</h2>
    <div id="pendingContainer"></div>
  </section>

  <!-- TO CONFIRM -->
  <section>
    <h2>Demandes envoyées</h2>
    <div id="toConfirmContainer"></div>
  </section>

  <!-- CHAT LIST -->
  <section>
    <h2>Chats</h2>
    <div id="chatListContainer"></div>
  </section>

  <!-- GROUPS -->
  <section>
    <h2>Groupes</h2>
    <div id="groupsContainer"></div>
    <input type="text" id="newGroupName" placeholder="Nom du groupe" style="width:70%; padding:5px;">
    <button id="createGroupBtn">Créer un groupe</button>
  </section>
</main>

<script type="module">
import { auth, db, sendFriendRequest, acceptFriendRequest, rejectFriendRequest, createGroup, listenMessages } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { ref, set, get, child, update, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const logoutBtn = document.getElementById("logoutBtn");
const allUsersContainer = document.getElementById("allUsersContainer");
const friendsContainer = document.getElementById("friendsContainer");
const pendingContainer = document.getElementById("pendingContainer");
const toConfirmContainer = document.getElementById("toConfirmContainer");
const chatListContainer = document.getElementById("chatListContainer");
const groupsContainer = document.getElementById("groupsContainer");
const newGroupName = document.getElementById("newGroupName");
const createGroupBtn = document.getElementById("createGroupBtn");

onAuthStateChanged(auth, async user => {
  if(!user) {
    window.location.replace("login.html");
    return;
  }

  const uid = user.uid;
  const dbRef = ref(db);

  logoutBtn.addEventListener("click", () => {
    auth.signOut().then(()=> window.location.replace("login.html"));
  });

  // ==================== ALL USERS ====================
  onValue(ref(db, "users"), snapshot => {
    const users = snapshot.val() || {};
    allUsersContainer.innerHTML = "";
    friendsContainer.innerHTML = "";
    pendingContainer.innerHTML = "";
    toConfirmContainer.innerHTML = "";

    Object.keys(users).forEach(userId => {
      const u = users[userId];
      if(userId === uid) return; // ignorer soi-même

      // Statut
      const isFriend = users[uid]?.friends?.[userId];
      const pendingReceived = users[uid]?.pendingRequests?.[userId];
      const pendingSent = users[uid]?.pendingRequestsSent?.[userId];

      // ALL USERS
      const divUser = document.createElement("div");
      divUser.className = "user-item";
      divUser.textContent = u.username;
      const btn = document.createElement("button");
      if(isFriend) btn.textContent = "Amis"; 
      else if(pendingSent) btn.textContent = "En attente"; 
      else btn.textContent = "Ajouter";
      btn.disabled = isFriend || pendingSent;
      btn.addEventListener("click", () => sendFriendRequest(userId));
      divUser.appendChild(btn);
      allUsersContainer.appendChild(divUser);

      // FRIENDS
      if(isFriend){
        const divFriend = document.createElement("div");
        divFriend.className = "friend-item";
        divFriend.textContent = u.username;
        friendsContainer.appendChild(divFriend);
      }

      // PENDING (demandes reçues)
      if(pendingReceived){
        const divPending = document.createElement("div");
        divPending.className = "friend-item";
        divPending.textContent = u.username;
        const btnAccept = document.createElement("button");
        btnAccept.textContent = "Accepter";
        btnAccept.addEventListener("click", () => acceptFriendRequest(userId));
        const btnReject = document.createElement("button");
        btnReject.textContent = "Refuser";
        btnReject.addEventListener("click", () => rejectFriendRequest(userId));
        divPending.appendChild(btnAccept);
        divPending.appendChild(btnReject);
        pendingContainer.appendChild(divPending);
      }

      // TO CONFIRM (demandes envoyées)
      if(pendingSent){
        const divSent = document.createElement("div");
        divSent.className = "friend-item";
        divSent.textContent = u.username;
        toConfirmContainer.appendChild(divSent);
      }
    });
  });

  // ==================== GROUPS ====================
  onValue(ref(db, "groups"), snapshot => {
    const groups = snapshot.val() || {};
    groupsContainer.innerHTML = "";
    Object.keys(groups).forEach(groupId => {
      const g = groups[groupId];
      if(!g.members[uid]) return; // afficher seulement ceux où l'utilisateur est membre
      const div = document.createElement("div");
      div.className = "group-item";
      div.textContent = g.name;
      const btn = document.createElement("button");
      btn.textContent = "Ouvrir chat";
      btn.addEventListener("click", () => {
        window.location.href = `chat.html?id=${groupId}&type=group`;
      });
      div.appendChild(btn);
      groupsContainer.appendChild(div);
    });
  });

  createGroupBtn.addEventListener("click", () => {
    const name = newGroupName.value.trim();
    if(!name) return alert("Entrez un nom de groupe !");
    createGroup(name);
    newGroupName.value = "";
  });

  // ==================== CHAT LIST ====================
  onValue(ref(db, "privateChats"), snapshot => {
    const chats = snapshot.val() || {};
    chatListContainer.innerHTML = "";
    Object.keys(chats).forEach(chatId => {
      const chat = chats[chatId];
      if(chatId.includes(uid)){ // simple check chat contient uid
        const div = document.createElement("div");
        div.className = "chat-item";
        div.textContent = "Chat privé";
        const btn = document.createElement("button");
        btn.textContent = "Ouvrir";
        btn.addEventListener("click", () => {
          window.location.href = `chat.html?id=${chatId}&type=private`;
        });
        div.appendChild(btn);
        chatListContainer.appendChild(div);
      }
    });
  });

});
</script>
</body>
</html>
